<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فاتورة الطلب - ابو محمد للذبائح</title>
    <!-- Include html2pdf Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            background-color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .invoice-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            overflow: hidden;
            position: relative;
        }

        .invoice-header {
            background: #2C5F2D;
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .invoice-header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 800;
        }

        .invoice-header p {
            opacity: 0.9;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 8rem;
            color: rgba(0, 0, 0, 0.03);
            font-weight: 900;
            z-index: 0;
            pointer-events: none;
            white-space: nowrap;
        }

        .invoice-body {
            padding: 30px;
            position: relative;
            z-index: 1;
        }

        .info-group {
            margin-bottom: 20px;
            border-bottom: 1px dashed #e5e7eb;
            padding-bottom: 15px;
        }

        .info-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .info-label {
            color: #6b7280;
            font-weight: 600;
        }

        .info-value {
            color: #1f2937;
            font-weight: 800;
            text-align: left;
        }

        .total-box {
            background: #fdfce8;
            border: 2px dashed #fcd34d;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .total-label {
            color: #b45309;
            font-weight: 800;
            font-size: 1.1rem;
        }

        .total-price {
            color: #2C5F2D;
            font-size: 1.5rem;
            font-weight: 900;
        }

        .actions-bar {
            padding: 20px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .print-btn {
            background: #2C5F2D;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            transition: 0.3s;
            margin-bottom: 5px;
        }

        .print-btn:hover {
            box-shadow: 0 4px 12px rgba(44, 95, 45, 0.3);
            transform: translateY(-2px);
        }

        /* Updated Print Styles */
        @media print {
            @page {
                size: A4;
                margin: 0;
                /* Remove browser default page margins */
            }

            body {
                margin: 0;
                padding: 0;
                background-color: white;
                height: 100%;
                display: block;
                /* Disable flex for print */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .invoice-container {
                box-shadow: none !important;
                border: none !important;
                width: 100% !important;
                max-width: none !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 20px !important;
                /* Internal padding for content */
                border-radius: 0 !important;
            }

            .actions-bar {
                display: none !important;
            }

            .invoice-header {
                background-color: #2C5F2D !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .total-box {
                background-color: #fdfce8 !important;
                border: 2px dashed #fcd34d !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .watermark {
                opacity: 0.1 !important;
                /* Make watermark very faint */
            }
        }
    </style>
</head>

<body>

    <div class="invoice-container" id="invoiceArea">
        <div class="invoice-header">
            <h2>ابو محمد للذبائح</h2>
            <p>فاتورة طلب إلكترونية</p>
        </div>

        <div class="watermark">PAID</div>

        <div class="invoice-body">

            <div id="loadingMsg" style="text-align: center; color: #6b7280; display: none;">جاري تحميل البيانات...</div>

            <div class="info-group">
                <div class="info-row">
                    <span class="info-label">رقم الفاتورة:</span>
                    <span class="info-value" id="orderId">#---</span>
                </div>
                <div class="info-row">
                    <span class="info-label">التاريخ:</span>
                    <span class="info-value" id="orderDate">---</span>
                </div>
                <div class="info-row">
                    <span class="info-label">حالة الطلب:</span>
                    <span class="info-value" style="color: green;">مؤكد ✅</span>
                </div>
            </div>

            <div class="info-group">
                <h3
                    style="font-size: 1.1rem; color: #2C5F2D; margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px; display: inline-block;">
                    بيانات العميل</h3>
                <div class="info-row">
                    <span class="info-label">الاسم:</span>
                    <span class="info-value" id="customerName">---</span>
                </div>
                <div class="info-row">
                    <span class="info-label">الجوال:</span>
                    <span class="info-value" dir="ltr" id="customerPhone">---</span>
                </div>
            </div>

            <div class="info-group">
                <h3
                    style="font-size: 1.1rem; color: #2C5F2D; margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px; display: inline-block;">
                    تفاصيل الطلب</h3>
                <div class="info-row">
                    <span class="info-label">المنتج:</span>
                    <span class="info-value" id="productName">---</span>
                </div>
                <div class="info-row">
                    <span class="info-label">العدد:</span>
                    <span class="info-value" id="qty">---</span>
                </div>
                <div class="info-row">
                    <span class="info-label">التقطيع:</span>
                    <span class="info-value" id="cutting">---</span>
                </div>
                <div class="info-row">
                    <span class="info-label">التغليف:</span>
                    <span class="info-value" id="packaging">---</span>
                </div>
                <div class="info-row">
                    <span class="info-label">الرأس:</span>
                    <span class="info-value" id="headOption">---</span>
                </div>
                <div class="info-row">
                    <span class="info-label">الاستلام:</span>
                    <span class="info-value" id="delivery">---</span>
                </div>
                <!-- Delivery Date -->
                <div class="info-row">
                    <span class="info-label">موعد المناسبة:</span>
                    <span class="info-value" id="deliveryDate">---</span>
                </div>
                <div class="info-row" id="notesRow" style="display:none;">
                    <span class="info-label">ملاحظات:</span>
                    <span class="info-value" id="notes">---</span>
                </div>
            </div>

            <div class="total-box">
                <span class="total-label">الإجمالي النهائي</span>
                <span class="total-price" id="totalPrice">0 ر.س</span>
            </div>

            <div style="margin-top: 30px; text-align: center;">
                <img id="qrCode" src="" alt="QR Code" style="width: 100px; opacity: 0.8;"
                    onerror="this.style.display='none'">
                <p style="font-size: 0.8rem; color: #9ca3af; margin-top: 5px;">امسح الكود للتحقق من الطلب</p>
            </div>

            <div id="previewBadge"
                style="display: none; background: #e0f2fe; color: #0369a1; padding: 10px; border-radius: 8px; font-size: 0.8rem; text-align: center; margin-top: 15px; border: 1px dashed #7dd3fc;">
                ⚠️ هذا عرض تجريبي لأحدث طلب تم تخزينه في جهازك
            </div>

        </div>

        <div class="actions-bar" data-html2canvas-ignore="true">
            <button class="print-btn" onclick="downloadPDF()">
                <i class="fa-solid fa-file-pdf"></i> تحميل ملف PDF
            </button>
            <button class="print-btn" onclick="window.print()" style="background: #4B5563;">
                <i class="fa-solid fa-print"></i> طباعة الفاتورة
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check params first, then fallback to localStorage for testing
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');

            let data = null;

            if (encodedData) {
                try {
                    const jsonString = decodeURIComponent(escape(atob(encodedData)));
                    data = JSON.parse(jsonString);
                } catch (e) {
                    console.error("Link parsing error", e);
                }
            } else {
                // Fallback: Try to get latest from localStorage
                const localOrders = localStorage.getItem('myOrders');
                if (localOrders) {
                    try {
                        const orders = JSON.parse(localOrders);
                        if (orders && orders.length > 0) {
                            data = orders[0]; // Get most recent
                            document.getElementById('previewBadge').style.display = 'block';
                        }
                    } catch (e) { console.error("Local storage error", e); }
                }
            }

            if (data) {
                populateInvoice(data);
            } else {
                // If really no data
                document.getElementById('loadingMsg').style.display = 'block';
                document.getElementById('loadingMsg').textContent = "لم يتم العثور على بيانات الفاتورة. يرجى التأكد من الرابط أو إنشاء طلب جديد.";
            }
        });

        function populateInvoice(data) {
            document.getElementById('orderId').textContent = '#' + (data.id || '---');
            document.getElementById('orderDate').textContent = data.timestamp || new Date().toLocaleDateString('ar-SA');
            document.getElementById('customerName').textContent = data.customer || '---';
            document.getElementById('customerPhone').textContent = data.phone || '---';
            document.getElementById('productName').textContent = data.product || '---';
            document.getElementById('qty').textContent = data.qty || '1';
            document.getElementById('cutting').textContent = data.cutting || '---';
            document.getElementById('packaging').textContent = data.plates || '---';
            document.getElementById('headOption').textContent = data.head || '---';
            document.getElementById('delivery').textContent = data.delivery || '---';
            document.getElementById('deliveryDate').textContent = data.date || data.timestamp || '---';
            document.getElementById('totalPrice').textContent = data.total || '0';

            if (data.notes) {
                document.getElementById('notesRow').style.display = 'flex';
                document.getElementById('notes').textContent = data.notes;
            }

            // Update Title
            document.title = ` فاتورة #${data.id}`;

            // Generate QR Code
            // If data came from localStorage, URL param isn't there, so QR might just point to base invoice page
            // Ideally we re-construct the link for the QR
            const currentPath = window.location.href.split('?')[0];
            // Encode data again to make a valid QR if someone scans it
            // Simplify data for QR to keep it small (optional)
            const jsonString = JSON.stringify(data);
            const enc = btoa(unescape(encodeURIComponent(jsonString)));
            const realLink = `${currentPath}?data=${enc}`;

            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(realLink)}`;
            document.getElementById('qrCode').src = qrUrl;
        }

        function downloadPDF() {
            const element = document.getElementById('invoiceArea');
            // Hide preview badge for PDF
            const badge = document.getElementById('previewBadge');
            if (badge) badge.style.display = 'none';

            const opt = {
                margin: 0,
                filename: `Invoice_${document.title}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            // Generate
            html2pdf().set(opt).from(element).save().then(() => {
                // Restore badge if needed
                if (badge && document.title.includes('تجريبي')) badge.style.display = 'block';
            });
        }
    </script>
</body>

</html>